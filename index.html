<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ACS藥物禁忌症核對清單</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone (for in-browser JSX/TS compilation) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Noto Sans TC', sans-serif;
        background-color: #111;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1b1b1b; 
      }
      ::-webkit-scrollbar-thumb {
        background: #333; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555; 
      }
      /* Animation */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out forwards;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react/": "https://aistudiocdn.com/react@^19.2.1/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect, useCallback, useMemo } = React;

      // ----------------------------------------------------------------------
      // TYPES & CONSTANTS
      // ----------------------------------------------------------------------
      const STORAGE_KEY = 'acs_drug_check_v1';

      interface ChecklistItem {
        id: string;
        label: React.ReactNode;
      }

      interface DrugConfig {
        id: string;
        name: string;
        doseHighlight: string;
        suffixNote: string;
        actionLabel: React.ReactNode;
        checklist: ChecklistItem[];
      }

      interface AppState {
        checks: Record<string, boolean>;
        timestamps: Record<string, string>;
      }

      const DRUG_DATA: DrugConfig[] = [
        {
          id: 'aspirin',
          name: 'Aspirin',
          doseHighlight: '3顆',
          suffixNote: '▶️需做EKG',
          actionLabel: <>口服<strong>3顆(300mg)</strong>絞碎吞下</>,
          checklist: [
            { id: 'asp_1', label: '病患對阿斯匹林類過敏' },
            { id: 'asp_2', label: '病患有嚴重貧血、凝血缺陷或服用抗凝血劑' },
            { id: 'asp_3', label: '病患有出血點、大片瘀血或疑似活動性病理性出血(例如:主動脈剝離、消化道出血)' },
            { id: 'asp_4', label: '病患有顱內出血病史' },
            { id: 'asp_5', label: <>需雙側肢體脈壓差<strong>&lt;20mmHg</strong></> },
          ],
        },
        {
          id: 'ntg',
          name: 'NTG最多',
          doseHighlight: '3顆',
          suffixNote: '▶️T2可協助給予',
          actionLabel: <>口服<strong>3顆(300mg)</strong>絞碎吞下</>,
          checklist: [
            { id: 'ntg_1', label: <>收縮壓<strong>&lt;90mmHg</strong></> },
            { id: 'ntg_2', label: <>脈搏<strong>&lt;50 次/分鐘</strong>。</> },
            { id: 'ntg_3', label: '服用中西壯陽藥者。' },
            { id: 'ntg_4', label: '對NTG過敏' },
            { id: 'ntg_5', label: '需做12導程ECG' },
            { id: 'ntg_6', label: '右心衰竭者(如有頸靜脈怒張或下肢嚴重水腫等症狀)。' },
          ],
        },
        {
          id: 'ticagrelor',
          name: 'Ticagrelor',
          doseHighlight: '2顆',
          suffixNote: '▶️需致電MD確認',
          actionLabel: <>通知線上醫導 口服<strong>2顆(180mg)</strong>絞碎吞下</>,
          checklist: [
            { id: 'tic_1', label: '病患對 Ticagrelor (Brilinta)類過敏' },
            { id: 'tic_2', label: '病患有嚴重貧血、凝血缺陷或服用抗凝血劑' },
            { id: 'tic_3', label: '病患有出血點、大片瘀血或疑似活動性病理性出血(例如:主動脈剝離、消化道出血)' },
            { id: 'tic_4', label: '病患有顱內出血病史' },
            { id: 'tic_5', label: '病患有嚴重肝功能不全' },
          ],
        },
      ];

      // ----------------------------------------------------------------------
      // STORAGE SERVICE
      // ----------------------------------------------------------------------
      const DEFAULT_STATE: AppState = {
        checks: {},
        timestamps: {},
      };

      const loadState = (): AppState => {
        try {
          const serialized = localStorage.getItem(STORAGE_KEY);
          if (!serialized) return DEFAULT_STATE;
          return JSON.parse(serialized) as AppState;
        } catch (error) {
          console.error("Failed to load state:", error);
          return DEFAULT_STATE;
        }
      };

      const saveState = (state: AppState): void => {
        try {
          const serialized = JSON.stringify(state);
          localStorage.setItem(STORAGE_KEY, serialized);
        } catch (error) {
          console.error("Failed to save state:", error);
        }
      };

      const clearStoredState = (): void => {
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch (error) {
          console.error("Failed to clear state:", error);
        }
      };

      // ----------------------------------------------------------------------
      // COMPONENT: DrugItem
      // ----------------------------------------------------------------------
      interface DrugItemProps {
        drug: DrugConfig;
        isOpen: boolean;
        onToggle: () => void;
        checks: Record<string, boolean>;
        timestamp: string | undefined;
        onCheckChange: (checkId: string) => void;
        onRecordAction: (drugId: string) => void;
      }

      const DrugItem: React.FC<DrugItemProps> = ({
        drug,
        isOpen,
        onToggle,
        checks,
        timestamp,
        onCheckChange,
        onRecordAction,
      }) => {
        
        const allChecked = useMemo(() => {
          return drug.checklist.every((item) => checks[item.id] === true);
        }, [drug.checklist, checks]);

        return (
          <div className="bg-[#1b1b1b] rounded-lg border-2 border-[#333] overflow-hidden transition-all duration-300">
            {/* Header / Button */}
            <button
              onClick={onToggle}
              className={`w-full text-center py-5 text-xl sm:text-2xl font-bold transition-all duration-300 relative
                ${isOpen ? 'bg-[#e91e63] shadow-[0_0_12px_rgba(233,30,99,0.5)]' : 'bg-[#1b1b1b] hover:bg-[#252525]'}
                text-white
              `}
            >
              {drug.name} <span className="text-[#ffd700] mx-1">{drug.doseHighlight}</span> {drug.suffixNote}
              
              {/* Checkmark indicator if done */}
              {timestamp && !isOpen && (
                  <span className="absolute right-4 top-1/2 -translate-y-1/2 text-green-400 text-sm font-normal border border-green-500 px-2 py-1 rounded hidden sm:block">
                      已完成
                  </span>
              )}
            </button>

            {/* Expandable Content */}
            {isOpen && (
              <div className="p-4 sm:p-6 border-t border-[#333] animate-fadeIn">
                <p className="text-[#ccc] font-bold mb-4 text-lg">請確認無以下禁忌症：</p>
                
                <div className="space-y-3">
                  {drug.checklist.map((item) => (
                    <label
                      key={item.id}
                      className="flex items-start sm:items-center space-x-3 cursor-pointer group"
                    >
                      <input
                        type="checkbox"
                        checked={!!checks[item.id]}
                        onChange={() => onCheckChange(item.id)}
                        disabled={!!timestamp}
                        className="mt-1 sm:mt-0 w-6 h-6 border-2 border-gray-500 rounded bg-gray-700 text-[#e91e63] focus:ring-offset-0 focus:ring-0 checked:bg-[#e91e63] checked:border-[#e91e63] transition cursor-pointer"
                      />
                      <span className={`text-[15px] sm:text-[16px] leading-relaxed select-none ${!!checks[item.id] ? 'text-white' : 'text-gray-400 group-hover:text-gray-200'}`}>
                        {item.label}
                      </span>
                    </label>
                  ))}
                </div>

                {/* Action Area */}
                <div className={`mt-6 transition-all duration-500 ${allChecked ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none absolute'}`}>
                  {allChecked && (
                    timestamp ? (
                      // State: Completed (Timestamp recorded)
                      <div className="bg-[#1b3a1b] border border-[#008800] text-white p-4 rounded-lg text-center shadow-[0_0_10px_#008800]">
                          <div className="text-sm text-green-300 mb-1">已執行於</div>
                          <div className="text-xl sm:text-2xl font-mono font-bold text-[#ffd700]">
                              {timestamp}
                          </div>
                          <div className="mt-2 text-sm opacity-75">{drug.actionLabel}</div>
                      </div>
                    ) : (
                      // State: Ready to record
                      <button
                        onClick={() => onRecordAction(drug.id)}
                        className="w-full bg-[#008800] hover:bg-[#00a000] active:scale-[0.98] text-white p-4 rounded-lg text-lg sm:text-xl font-bold text-center shadow-[0_0_10px_#008800] transition-all duration-200 flex flex-col items-center justify-center gap-2"
                      >
                        <span className="animate-pulse">⚠️ 點擊紀錄時間</span>
                        <span>{drug.actionLabel}</span>
                      </button>
                    )
                  )}
                </div>
              </div>
            )}
          </div>
        );
      };

      // ----------------------------------------------------------------------
      // COMPONENT: App
      // ----------------------------------------------------------------------
      const App: React.FC = () => {
        const [appState, setAppState] = useState<AppState>({ checks: {}, timestamps: {} });
        const [expandedId, setExpandedId] = useState<string | null>(null);
        const [isLoaded, setIsLoaded] = useState(false);

        // 1. Initial Load
        useEffect(() => {
          const loaded = loadState();
          setAppState(loaded);
          setIsLoaded(true);
        }, []);

        // 2. Save on Change (only if loaded)
        useEffect(() => {
          if (isLoaded) {
            saveState(appState);
          }
        }, [appState, isLoaded]);

        const handleCheckChange = useCallback((checkId: string) => {
          setAppState((prev) => ({
            ...prev,
            checks: {
              ...prev.checks,
              [checkId]: !prev.checks[checkId],
            },
          }));
        }, []);

        const handleRecordAction = useCallback((drugId: string) => {
          const now = new Date();
          const timeString = now.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
          
          setAppState((prev) => ({
            ...prev,
            timestamps: {
              ...prev.timestamps,
              [drugId]: timeString,
            },
          }));
        }, []);

        const handleReset = useCallback(() => {
          if (window.confirm('確定要重置所有紀錄嗎？此動作無法復原。')) {
            clearStoredState(); // Clear LocalStorage
            setAppState({ checks: {}, timestamps: {} }); // Clear React State
            setExpandedId(null); // Close Accordions
          }
        }, []);

        const handleToggle = useCallback((id: string) => {
          setExpandedId((prev) => (prev === id ? null : id));
        }, []);

        if (!isLoaded) return null;

        return (
          <div className="min-h-screen bg-[#111] text-white p-4 pb-20 sm:p-6 max-w-3xl mx-auto">
            
            {/* Header Area */}
            <div className="flex flex-col items-center justify-center mb-8 relative">
              <h2 className="text-2xl sm:text-3xl font-bold text-[#5dc1ff] text-center mb-4 sm:mb-0">
                ACS藥物禁忌症核對
              </h2>
              
              {/* Reset Button */}
              <button 
                onClick={handleReset}
                className="mt-4 sm:absolute sm:right-0 sm:top-1/2 sm:-translate-y-1/2 text-xs sm:text-sm bg-gray-800 hover:bg-red-900 text-gray-300 hover:text-white px-3 py-2 rounded border border-gray-600 transition-colors z-10 cursor-pointer"
              >
                重置表格 ↺
              </button>
            </div>

            {/* Main List */}
            <div className="flex flex-col gap-4">
              {DRUG_DATA.map((drug) => (
                <DrugItem
                  key={drug.id}
                  drug={drug}
                  isOpen={expandedId === drug.id}
                  onToggle={() => handleToggle(drug.id)}
                  checks={appState.checks}
                  timestamp={appState.timestamps[drug.id]}
                  onCheckChange={handleCheckChange}
                  onRecordAction={handleRecordAction}
                />
              ))}
            </div>

            <div className="mt-12 text-center text-gray-500 text-sm">
              <p>資料會自動儲存於此裝置</p>
            </div>
          </div>
        );
      };

      // ----------------------------------------------------------------------
      // MOUNT
      // ----------------------------------------------------------------------
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>